# microBPF Development Progress

## Project Summary
microBPF is a sandboxed, event-driven in-kernel programmability system for constrained
kernels (RTOS, microkernels, embedded). Uses MQuickJS as execution engine.
Defines: host ABI (helpers/maps), .mbpf package format, runtime resource model, hook model.

## Tasks Identified: 97 total
- Infrastructure: 12 (setup, tests, docs)
- Functional: 71 (package format, runtime, maps, helpers, hooks, toolchain)
- Security: 8 (signing, capabilities, isolation, fuzzing)
- Performance: 4 (ROM stdlib, lock-free reads, no-alloc paths)

## Recommended Architecture
- Language: C (for embedded compatibility and MQuickJS integration)
- Build: CMake or Makefile (cross-platform, embedded-friendly)
- MQuickJS: Git submodule or vendored copy
- Toolchain: Separate CLI tools in C or Python for .mbpf assembly
- Tests: Unity or custom C test framework; fuzzing via libFuzzer

## Current Status
NOT YET IMPLEMENTED. First working agent should start with "project-setup" task.

## Key Implementation Phases (from spec)
1. Runtime MVP: package parsing, single hook, step budgeting, log helper
2. Maps MVP: array + hash maps, JS map API
3. Attach API: hook registry, multiple programs, per-CPU instances
4. Signing: Ed25519 verification and policy engine
5. Observability: counters, debug symbols, event output
- 2024-12-24: Project setup complete with MQuickJS integration and build scaffolding.
- 2025-12-24: Package header parsing implemented (magic/version/header size/section count) and tests/tools added.
- 2025-12-24: Implemented .mbpf section descriptor parsing with bounds/overlap validation and added section table tests.
- 2025-12-24: Package manifest parsing completed with CBOR/JSON support and manifest tests.
- 2025-12-24: Bytecode section handling now validates, relocates, and loads MQuickJS bytecode with tests.
- 2025-12-24: Added CRC32 validation for package headers/sections with tests.
- 2025-12-24: Added Ed25519 package signature verification, header APIs, and signing tests.
- 2025-12-24: Reviewed and validated runtime init/shutdown APIs with runtime tests.
- 2025-12-24: Verified mbpf_program_load basic behavior with new program load tests.
- 2025-12-24: Completed program load validation checks (heap minimum enforcement) with comprehensive tests.
- 2025-12-24: Implemented mbpf_program_unload with mbpf_fini handling and added program unload tests.
- 2025-12-24: Implemented program attach/detach hook binding with runtime execution tests.
- 2025-12-24: Validated attach hook type and context ABI version checks with new attach validation tests.
instance-creation: reviewed and fixed per-CPU instance selection guard
- 2025-12-24: Reviewed runtime-run-basic; mbpf_run executes attached programs with new run tests.
- 2025-12-24: Completed runtime context object support with NET_RX field exposure and tests.
- 2025-12-24: Implemented ctx.readU8/readU16LE/readU32LE/readBytes with NET_RX tests.
- 2025-12-24: Reviewed NET_RX v1 context binding, flags exposure, and added context tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_TRACEPOINT context binding and tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_TIMER context binding and tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_NET_RX decision hook tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_NET_TX hook tests and context.
- 2025-12-24: Reviewed and validated MBPF_HOOK_SECURITY authorization hook with new security context tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_CUSTOM support with custom context accessors and tests.
entry-point-mbpf-prog: verified entry function required and called
entry-point-mbpf-init: verified optional mbpf_init load-time entry
entry-point-mbpf-fini: verified optional mbpf_fini unload entry
return-value-semantics: verified 32-bit signed return value handling
exception-handling: reviewed exception defaults and tests
- Completed map-array-basic review: array map lookup/update and tests added.
- Completed map-hash-basic review: added hash map lookup/update/delete and tests.
- Completed map-hash-collision review: collision/tombstone/high-load hash map tests added.
- Completed map-max-entries review: added capacity enforcement tests.
- Completed map-type-validation review: added map type/size validation tests.
- 2025-12-24: Completed map-lru-hash review with LRU hash map updates and tests.
- 2025-12-24: Completed map-per-cpu review with per-CPU map support and tests.
- 2025-12-24: Completed map-ring-buffer review and fixes with ring buffer host APIs, JS sync, and tests.
- 2025-12-24: Completed map-counter review with counter map runtime sync, JS API, and tests.
- 2025-12-24: Completed map-iteration review with nextKey support and tests.
- 2025-12-24: Completed map-persistence review with program update map preservation and tests.
- 2025-12-24: Completed map-concurrency review with concurrency tests and build integration.
- 2025-12-24: Completed helper-api-version review with mbpf.apiVersion support and tests.
- 2025-12-24: Completed helper-log review with mbpf.log helper and tests.
- 2025-12-24: Completed helper-u64-load-store review with mbpf.u64LoadLE/u64StoreLE helpers and tests.
- 2025-12-25: Completed helper-now-ns review with mbpf.nowNs helper gating and tests.
- 2025-12-25: Completed helper-emit review with mbpf.emit buffer sync and tests.
- 2025-12-25: Completed helper-stats review with mbpf.stats helper gating, runtime sync, and tests.
2025-12-25 helper-map-lowlevel: added low-level map helpers and tests.
2025-12-25 budget-max-steps: enforced max_steps budget via interrupt handler and tests.
2025-12-25 budget-max-helpers: enforced max_helpers helper budget and added tests.
budget-max-wall-time: reviewed and fixed wall time elapsed calculation
2025-12-25 budget-interrupt-handler: added interrupt handler budget enforcement tests.
2025-12-25 memory-heap-size: verified heap OOM handling and added tests.
2025-12-25 memory-minimum-heap: verified minimum heap rejection and added tests.
2025-12-25 capability-enforcement: reviewed load-time capability allow-list enforcement and runtime helper gating tests.
2025-12-25 capability-categories: reviewed capability category gating and tests.
2025-12-25 nested-execution-prevention: reviewed nested execution guard, safe default propagation, and tests.
2025-12-25 failure-isolation: reviewed failure isolation tests and integration.
2025-12-25 circuit-breaker: reviewed optional circuit breaker and tests.
2025-12-25 api-version-enforcement: reviewed helper API version compatibility enforcement and tests.
2025-12-25 per-helper-versioning: reviewed per-helper version enforcement and tests.
2025-12-25 typed-array-shim: reviewed typed array shim and fixed JS_Eval lengths in tests.
- 2025-01-13: Verified allocation-free helper behavior; added tests, updated stats helper to require preallocated output, and documented API change.
2025-12-25 gc-reference-handling: reviewed JSGCRef registration, cleanup, and GC stress tests.
2025-12-25 deferred-execution-queue: reviewed deferred execution queue and fixed tracepoint read_fn snapshotting.
2025-12-25 deferred-execution-backpressure: reviewed deferred queue backpressure handling, stats updates, and tests.
2025-12-25 deferred-context-snapshot: reviewed deferred context snapshot tests and queue behavior.
2025-12-25 global-mbpf-object: reviewed global mbpf object helpers and tests.
2025-12-25 global-maps-object: reviewed global maps object tests.
2025-12-25 global-console-debug: reviewed console.log debug gating and tests.
disallowed-globals: disabled Function/eval globals and added security tests.
2025-12-25 toolchain-js-compile: reviewed toolchain JS compile fixes.
2025-12-25 toolchain-manifest-gen: reviewed manifest generation APIs, tests, and tooling.
