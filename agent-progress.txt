# microBPF Development Progress

## Project Summary
microBPF is a sandboxed, event-driven in-kernel programmability system for constrained
kernels (RTOS, microkernels, embedded). Uses MQuickJS as execution engine.
Defines: host ABI (helpers/maps), .mbpf package format, runtime resource model, hook model.

## Tasks Identified: 97 total
- Infrastructure: 12 (setup, tests, docs)
- Functional: 71 (package format, runtime, maps, helpers, hooks, toolchain)
- Security: 8 (signing, capabilities, isolation, fuzzing)
- Performance: 4 (ROM stdlib, lock-free reads, no-alloc paths)

## Recommended Architecture
- Language: C (for embedded compatibility and MQuickJS integration)
- Build: CMake or Makefile (cross-platform, embedded-friendly)
- MQuickJS: Git submodule or vendored copy
- Toolchain: Separate CLI tools in C or Python for .mbpf assembly
- Tests: Unity or custom C test framework; fuzzing via libFuzzer

## Current Status
NOT YET IMPLEMENTED. First working agent should start with "project-setup" task.

## Key Implementation Phases (from spec)
1. Runtime MVP: package parsing, single hook, step budgeting, log helper
2. Maps MVP: array + hash maps, JS map API
3. Attach API: hook registry, multiple programs, per-CPU instances
4. Signing: Ed25519 verification and policy engine
5. Observability: counters, debug symbols, event output
- 2024-12-24: Project setup complete with MQuickJS integration and build scaffolding.
- 2025-12-24: Package header parsing implemented (magic/version/header size/section count) and tests/tools added.
- 2025-12-24: Implemented .mbpf section descriptor parsing with bounds/overlap validation and added section table tests.
- 2025-12-24: Package manifest parsing completed with CBOR/JSON support and manifest tests.
- 2025-12-24: Bytecode section handling now validates, relocates, and loads MQuickJS bytecode with tests.
- 2025-12-24: Added CRC32 validation for package headers/sections with tests.
- 2025-12-24: Added Ed25519 package signature verification, header APIs, and signing tests.
- 2025-12-24: Reviewed and validated runtime init/shutdown APIs with runtime tests.
- 2025-12-24: Verified mbpf_program_load basic behavior with new program load tests.
- 2025-12-24: Completed program load validation checks (heap minimum enforcement) with comprehensive tests.
- 2025-12-24: Implemented mbpf_program_unload with mbpf_fini handling and added program unload tests.
- 2025-12-24: Implemented program attach/detach hook binding with runtime execution tests.
- 2025-12-24: Validated attach hook type and context ABI version checks with new attach validation tests.
instance-creation: reviewed and fixed per-CPU instance selection guard
- 2025-12-24: Reviewed runtime-run-basic; mbpf_run executes attached programs with new run tests.
- 2025-12-24: Completed runtime context object support with NET_RX field exposure and tests.
- 2025-12-24: Implemented ctx.readU8/readU16LE/readU32LE/readBytes with NET_RX tests.
- 2025-12-24: Reviewed NET_RX v1 context binding, flags exposure, and added context tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_TRACEPOINT context binding and tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_TIMER context binding and tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_NET_RX decision hook tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_NET_TX hook tests and context.
- 2025-12-24: Reviewed and validated MBPF_HOOK_SECURITY authorization hook with new security context tests.
- 2025-12-24: Reviewed and validated MBPF_HOOK_CUSTOM support with custom context accessors and tests.
entry-point-mbpf-prog: verified entry function required and called
entry-point-mbpf-init: verified optional mbpf_init load-time entry
entry-point-mbpf-fini: verified optional mbpf_fini unload entry
return-value-semantics: verified 32-bit signed return value handling
exception-handling: reviewed exception defaults and tests
- Completed map-array-basic review: array map lookup/update and tests added.
- Completed map-hash-basic review: added hash map lookup/update/delete and tests.
- Completed map-hash-collision review: collision/tombstone/high-load hash map tests added.
- Completed map-max-entries review: added capacity enforcement tests.
- Completed map-type-validation review: added map type/size validation tests.
- 2025-12-24: Completed map-lru-hash review with LRU hash map updates and tests.
- 2025-12-24: Completed map-per-cpu review with per-CPU map support and tests.
- 2025-12-24: Completed map-ring-buffer review and fixes with ring buffer host APIs, JS sync, and tests.
- 2025-12-24: Completed map-counter review with counter map runtime sync, JS API, and tests.
- 2025-12-24: Completed map-iteration review with nextKey support and tests.
- 2025-12-24: Completed map-persistence review with program update map preservation and tests.
- 2025-12-24: Completed map-concurrency review with concurrency tests and build integration.
- 2025-12-24: Completed helper-api-version review with mbpf.apiVersion support and tests.
- 2025-12-24: Completed helper-log review with mbpf.log helper and tests.
- 2025-12-24: Completed helper-u64-load-store review with mbpf.u64LoadLE/u64StoreLE helpers and tests.
- 2025-12-25: Completed helper-now-ns review with mbpf.nowNs helper gating and tests.
- 2025-12-25: Completed helper-emit review with mbpf.emit buffer sync and tests.
- 2025-12-25: Completed helper-stats review with mbpf.stats helper gating, runtime sync, and tests.
2025-12-25 helper-map-lowlevel: added low-level map helpers and tests.
2025-12-25 budget-max-steps: enforced max_steps budget via interrupt handler and tests.
2025-12-25 budget-max-helpers: enforced max_helpers helper budget and added tests.
budget-max-wall-time: reviewed and fixed wall time elapsed calculation
2025-12-25 budget-interrupt-handler: added interrupt handler budget enforcement tests.
2025-12-25 memory-heap-size: verified heap OOM handling and added tests.
2025-12-25 memory-minimum-heap: verified minimum heap rejection and added tests.
2025-12-25 capability-enforcement: reviewed load-time capability allow-list enforcement and runtime helper gating tests.
2025-12-25 capability-categories: reviewed capability category gating and tests.
2025-12-25 nested-execution-prevention: reviewed nested execution guard, safe default propagation, and tests.
2025-12-25 failure-isolation: reviewed failure isolation tests and integration.
2025-12-25 circuit-breaker: reviewed optional circuit breaker and tests.
2025-12-25 api-version-enforcement: reviewed helper API version compatibility enforcement and tests.
2025-12-25 per-helper-versioning: reviewed per-helper version enforcement and tests.
2025-12-25 typed-array-shim: reviewed typed array shim and fixed JS_Eval lengths in tests.
- 2025-01-13: Verified allocation-free helper behavior; added tests, updated stats helper to require preallocated output, and documented API change.
2025-12-25 gc-reference-handling: reviewed JSGCRef registration, cleanup, and GC stress tests.
2025-12-25 deferred-execution-queue: reviewed deferred execution queue and fixed tracepoint read_fn snapshotting.
2025-12-25 deferred-execution-backpressure: reviewed deferred queue backpressure handling, stats updates, and tests.
2025-12-25 deferred-context-snapshot: reviewed deferred context snapshot tests and queue behavior.
2025-12-25 global-mbpf-object: reviewed global mbpf object helpers and tests.
2025-12-25 global-maps-object: reviewed global maps object tests.
2025-12-25 global-console-debug: reviewed console.log debug gating and tests.
disallowed-globals: disabled Function/eval globals and added security tests.
2025-12-25 toolchain-js-compile: reviewed toolchain JS compile fixes.
2025-12-25 toolchain-manifest-gen: reviewed manifest generation APIs, tests, and tooling.
toolchain-mbpf-assemble: reviewed mbpf assembly tool, added validation for NULL section data.
2025-12-25 toolchain-signing: reviewed Ed25519 signing toolchain, tests, and verification flow.
2025-12-25 observability-counters: reviewed per-program statistics counters.
2025-12-25 observability-trace-logs: reviewed trace logging with rate limiting.
2025-12-25 observability-debug-symbols: add debug section parsing and runtime API
2025-12-25 target-word-size: reviewed target word size enforcement and tests.
2025-12-25 target-endianness: reviewed target endianness enforcement and tests.
2025-12-25 example-net-rx-filter: reviewed example NET_RX filter test coverage and integration.
2025-12-25 u64-representation: reviewed u64 [lo, hi] representation tests.
2025-12-25 rom-resident-stdlib: reviewed ROM-resident stdlib tests and integration.
2025-12-25 no-dynamic-alloc-runtime: reviewed no-dynamic-alloc runtime tests.
2025-12-26 context-object-reuse: reviewed ctx reuse changes and tests.
2025-12-26 lock-free-map-reads: reviewed lock-free map read API and tests.
2025-12-26 error-invalid-package: reviewed invalid package error handling and error string coverage.
2025-12-26 error-hook-mismatch: reviewed hook mismatch error tests and integration.
2025-12-26 error-capability-denied: reviewed capability denial error handling and tests.
2025-12-26 test-unit-package-parser: reviewed package parser unit tests.
2025-12-26 test-unit-map-operations: reviewed map operations unit tests.
2025-12-26 test-unit-budget-enforcement: reviewed budget enforcement unit tests.
2025-12-26 test-integration-load-run: reviewed integration load/run cycle tests.
2025-12-26 test-integration-maps: reviewed integration map persistence tests.
2025-12-26 test-fuzz-package-parser: reviewed fuzz harness and corpus for .mbpf parser.
2025-12-26 test-fuzz-helper-boundary: reviewed helper boundary fuzz harness.
2025-12-26 docs-api-reference: reviewed and completed C API reference doc.
2025-12-26 docs-js-api-reference: reviewed JS API reference doc.
docs-package-format: documented .mbpf package format for tooling authors.
2025-12-26 package-section-bounds-overflow: reviewed overflow-safe section bounds checks and tests.
2025-12-26 map-allocation-overflow: reviewed map allocation overflow checks and tests.
2025-12-26 runtime-js-codegen-sizing: reviewed JS codegen sizing resilience and tests.
2025-12-26 runtime-map-name-escaping: reviewed map name validation/escaping and tests.
2025-12-26 ring-buffer-sync-bounds: reviewed ring buffer sync bounds, chunking, and size validation.
2025-12-26 map-write-concurrency: reviewed map writer serialization and concurrency tests.
[2025-12-29T23:24:50.536Z] Audit (codex): FAIL, 7 area(s), 15 new, lens=integration-testing.
- 2025-12-29 fix-new-lru-compile-error: PASS; removed stray LRU writer lock init in per-CPU array resize and cleaned map name length warning.
- Updated map resize path and JS maps object sizing logic.
- Files changed: src/mbpf_runtime.c.
- Task status update: task_list.json set fix-new-lru-compile-error passes=true.
- Build: make -B build/libmbpf.a (mbpf_runtime.c compiles cleanly; deps/mquickjs still emit existing warnings).
- Tests: make build/test_lru_hash_map && ./build/test_lru_hash_map (PASS).
- Init: ./init.sh --quick failed in test_program_unload (mbpf_fini_called_if_defined, mbpf_fini_throws_exception).
- Challenge: init.sh --quick still failing due to program unload tests.
- Resolution: not addressed in this session; failure persists for follow-up.
- Follow-up: investigate mbpf_program_load failures in tests/test_program_unload.c when mbpf_fini is defined.
- fix-manifest-json-size-off-by-one: PASS; aligned JSON size semantics to include NUL and updated generator sizing behavior.
- Added JSON exact-size unit test and adjusted manifest generator/test/tool docs to use size-including-NUL convention.
- Fixed manifest JSON builders with hook_type arg ordering in context/exception/return/log/hash tests to avoid target mismatch load failures.
- Increased GC reference test heap size for heavy allocation stress to avoid OOM during GC stress.
- Updated runtime defaults to apply when config struct is partially filled and added CAP_MAP_ITERATE to default allowlist.
- Files changed: src/mbpf_manifest_gen.c, include/mbpf_manifest_gen.h, tests/test_manifest_gen.c, tools/mbpf_manifest_gen.c, docs/C_API_REFERENCE.md.
- Additional fixes: src/mbpf_runtime.c, tests/test_context_read_methods.c, tests/test_context_net_rx_v1.c, tests/test_exception_handling.c, tests/test_return_value.c, tests/test_helper_log.c, tests/test_hash_map.c, tests/test_gc_reference.c.
- Tests: make build/test_program_unload && ./build/test_program_unload (PASS).
- Tests: make build/test_context_read_methods && ./build/test_context_read_methods (PASS).
- Tests: make build/test_context_net_rx_v1 && ./build/test_context_net_rx_v1 (PASS).
- Tests: make build/test_exception_handling && ./build/test_exception_handling (PASS).
- Tests: make build/test_map_iteration && ./build/test_map_iteration (PASS).
- Tests: make build/test_gc_reference && ./build/test_gc_reference (PASS).
- Tests: make build/test_manifest_gen && ./build/test_manifest_gen (PASS).
- Tests: ./init.sh --quick (PASS) and ./init.sh (PASS).
- Challenges: init.sh exposed multiple test manifest arg-order bugs and GC stress OOM; resolved by fixing manifest argument order and raising GC stress heap size.
- Follow-ups: none.
- enforce-budgets-required-keys: PASS.
- Added required-field enforcement for budgets.max_steps/max_helpers in CBOR/JSON manifest parsing.
- Added negative load tests for missing budget keys in validation suite.
- Files changed: src/mbpf_package.c.
- Files changed: tests/test_program_load_validation.c.
- Files changed: task_list.json.
- Tests: make build/test_program_load_validation && ./build/test_program_load_validation (PASS).
- Tests: make build/test_manifest_gen && ./build/test_manifest_gen (PASS).
- Tests: ./init.sh (PASS).
- Challenges: none.
[2025-12-30T00:31:24.919Z] Auto-commit note (working)
- Task: enforce-budgets-required-keys
- Outcome: ERROR
- Codex working session error: Codex working produced no agent messages
- Auto-commit created by harness for uncommitted changes.
- Next session: review the "Auto-commit uncommitted changes (working)" commit before resuming.
- 2025-12-30: validate-ctx-abi-version-at-run PASS.
- Added ctx ABI version guard in mbpf_run/run_on_instance to skip execution on mismatch.
- Added context ABI mismatch test to ensure safe default returned without execution.
- Files changed: src/mbpf_runtime.c, tests/test_context_object.c, task_list.json.
- Tests: make build/test_context_object && ./build/test_context_object (PASS).
- Tests: ./init.sh (PASS).
- Challenges: init.sh --quick initial timeout; reran with longer timeout.
- Resolution: reran init.sh --quick with higher timeout and full init.sh after changes.
- Follow-ups: none.
- fix-ctx-data-len-after-read-fn: PASS.
- Updated ctx.data_len handling to use actual snapshot/read_fn byte count for ctx reuse + per-invocation contexts.
- Added read_fn short-read regression test in context read methods.
- Fixed custom hook ctx reuse fallback to ensure custom field accessors are generated when fields are provided.
- Files changed: src/mbpf_runtime.c, tests/test_context_read_methods.c, task_list.json.
- Tests: make build/test_context_read_methods && ./build/test_context_read_methods (PASS).
- Tests: make build/test_context_net_rx_v1 && ./build/test_context_net_rx_v1 (PASS).
- Tests: make build/test_hook_tracepoint && ./build/test_hook_tracepoint (PASS).
- Tests: make build/test_hook_security && ./build/test_hook_security (PASS).
- Tests: make build/test_hook_net_rx && ./build/test_hook_net_rx (PASS).
- Tests: make build/test_hook_custom && ./build/test_hook_custom (PASS).
- Tests: ./init.sh (PASS).
- Challenges: custom hook field accessor tests failed due to reusable ctx lacking dynamic fields.
- Resolution: fallback to per-invocation ctx creation for custom hooks with fields.
- 2025-12-30 fix-mbpf-log-allocation-free: PASS.
- Refactored mbpf.log helper to avoid String/concat and select prefixes without array indexing.
- Added JS heap usage accessor and instance heap usage API for allocation checks.
- Added allocation-free mbpf.log test comparing heap growth baseline vs log runs.
- Files changed: src/mbpf_runtime.c, tests/test_allocation_free_helpers.c, include/mbpf.h, deps/mquickjs/mquickjs.c, deps/mquickjs/mquickjs.h, task_list.json.
- Tests: make build/test_allocation_free_helpers && ./build/test_allocation_free_helpers (PASS).
- Tests: make build/test_helper_log && ./build/test_helper_log (PASS).
- Tests: make build/test_typed_array_shim && ./build/test_typed_array_shim (PASS).
- Init: ./init.sh (PASS).
- Challenges: allocation test initially failed due to baseline heap growth; resolved by measuring log vs no-log growth.
- 2025-12-30: toolchain-assemble-signing-test-builds-tools PASS.
- Added build-or-skip helpers to toolchain assemble/signing shell tests to build required binaries on demand.
- Ensured missing make/tools emit SKIP with actionable guidance instead of hard failure.
- Files changed: tests/test_toolchain_assemble.sh.
- Files changed: tests/test_toolchain_signing.sh.
- Task status update: task_list.json set toolchain-assemble-signing-test-builds-tools completed=true.
- Tests: tests/test_toolchain_assemble.sh (PASS; auto-built mbpf_assemble).
- Tests: tests/test_toolchain_signing.sh (PASS; auto-built mbpf_sign/mbpf_manifest_gen).
- Challenges: missing tool binaries at test start.
- Resolution: build via make targets inside tests before execution.
- Tests: ./init.sh (PASS; reported a link error building build/test_rom_stdlib but init.sh completed successfully).
- toolchain-signing-loads-signed-package: PASS.
- Added loader step to signing integration script that compiles a small C harness and calls mbpf_program_load on the signed .mbpf.
- Files changed: tests/test_toolchain_signing.sh, task_list.json.
- Tests: tests/test_toolchain_signing.sh (PASS).
- Init: ./init.sh --quick (PASS).
- Challenge: loader compile failed due to library order in the link line.
- Resolution: moved -lmbpf/-lm after the source file in tests/test_toolchain_signing.sh.
- Follow-ups: none.
- Tests: ./init.sh (PASS).
- assemble-test-endianness-strings: PASS.
- Updated assemble test manifest to emit string endianness values ("little"/"big").
- Files changed: tests/test_mbpf_assemble.c, task_list.json.
- Tests: make build/test_mbpf_assemble && ./build/test_mbpf_assemble (PASS).
- Tests: ./init.sh (PASS).
- Challenges: init.sh --quick initial timeout during setup.
- Resolution: reran init.sh --quick with higher timeout; init.sh completed.
- Follow-ups: none.
- add-read-fn-coverage-across-hooks: PASS.
- Added read_fn-backed TRACEPOINT/SECURITY/CUSTOM hook tests plus short-read cases validating data_len update and bounds exceptions.
- Files changed: tests/test_hook_tracepoint.c.
- Files changed: tests/test_hook_security.c.
- Files changed: tests/test_hook_custom.c.
- Files changed: task_list.json.
- Tests: make build/test_hook_tracepoint && ./build/test_hook_tracepoint (PASS).
- Tests: make build/test_hook_security && ./build/test_hook_security (PASS).
- Tests: make build/test_hook_custom && ./build/test_hook_custom (PASS).
- Tests: ./init.sh --quick (PASS) and ./init.sh (PASS).
- Challenges: none.
[2026-01-07T18:51:21.730Z] Instruction: "Write comprehensive documentation including README..." -> 7 task(s)
- 2026-01-07: create-readme-overview PASS.
- Added top-level README with overview, build/test steps, toolchain quickstart, and docs links.
- Fixed Makefile test target to build mbpf_assemble for toolchain integration test.
- Files changed: README.md, Makefile, task_list.json.
- Tests: make test (PASS).
- Tests: ./init.sh (PASS; build/test_rom_stdlib link error still emitted but script reports success).
- Challenge: make test failed when toolchain integration couldn't find mbpf_assemble.
- Resolution: add $(ASSEMBLE_TOOL) dependency to Makefile test target.
- Follow-ups: investigate build/test_rom_stdlib link error reported during init.sh.
